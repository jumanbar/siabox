---
output:
  github_document:
    toc: true
    toc_depth: 2
editor_options:
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd.

Pendientes:

Cambiar documentación de sia_datos_muestra_parametros: id_dato en vez de id.
Lo mismo para datos_sia

Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
set.seed(0)
# Esto genera mensajes de advertencia normales:
# d <- filtrar_datos(datos_sia, id_programa = 10L, id_matriz = 6L,
#                    rango_fechas = c('2015-01-01', '2019-12-31'),
#                    tipo_punto_id = 1L,
#                    id_parametro = c(2098, 2101, 2099, 2097, 2102, 2032,
#                                     2018, 2090, 2021, 2017))

d <- siabox::filtrar_datos(siabox::datos_sia, 
                           id_programa = 10L, id_matriz = 6L,
                           rango_fechas = c('2019-01-01', '2019-12-31'),
                           tipo_punto_id = 1L,
                           id_parametro = c(2098, 2101, 2099, 2097, 2102, 2032,
                                            2018, 2090, 2021, 2017))
                     # c(2000L, 2017L, 2018L, 2021L, 2032L, 2090L,
                     #                2097L, 2098L, 2099L, 2101L, 2102L)
saveRDS(d, 'extraccion_20210514.rds')
```

# siabox

<!-- badges: start -->
<!-- badges: end -->

Este paquete contiene funciones y datos utilizados para trabajar con las bases datos del SIA. De momento no es muy grande pero abarca tareas diversas, tales como las que se usan en las aplicaciónes Shiny (vSIA, hSIA e iSIA), o funciones para hacer gráficas que sirven para hacer informes.

Tiene además un grupo no menor de tablas, incluyendo varias de la base de datos INFAMBIENTALBD del SIA.

Para usar el paquete se recomienda el uso de [tidyverse](https://www.tidyverse.org/) en general y muchos de los paquetes necesarios son de ese conjunto. Los ejemplos mostrados aquí en las distintas viñetas usan las funciones de `tidyverse` extensivamente.

## Instalación

El paquete se puede instalar desde GitHub (12/3/2021: no se ha puesto a prueba aún):

```r
# install.packages("devtools")
devtools::install_github("jumanbar/siabox")
```

## Modo de uso

La idea es que el paquete trabaje en conjunto con la aplicación [iSIA](). En la práctica, el flujo puede tomar dos caminos:

1. Se puede trabajar con datos extraidos de la aplicación [iSiA]() en el momento.

2. Se pueden usar datos que ya están en el paquete para analizar o hacer pruebas. El código así generado luego se puede utilizar para datos descargados desde [iSIA]().

Uno de los objetivos más importantes es que las herramientas del paquete sirvan para elaborar **informes automatizados**, mediante Rmarkdown. Hay un ejemplo (en construcción) con datos del programa Laguna Merín para tomar de referencia:

```r
# Tres formatos de salda posibles: PDF, HTML y DOC
demo('informe-laguna-merin-pdf',  'siabox')
demo('informe-laguna-merin-html', 'siabox')
demo('informe-laguna-merin-doc',  'siabox')
```
### Con extracciones de iSIA

El siguiente es un ejemplo que usa datos extraídos de iSIA (formato 'largo'):

- Programa: Laguna Merín
- Año de las muestras: 2019
- Matriz: Aguas superficiales
- Muestras: superficie
- Parámetros: ClorofilaA, NAmoniacal, NO2, NO3, NT, OD, pH, PO4, PT, SatO2 y T

Cargar los datos en la sesión, bajo el nombre `d` (asume que el archivo se encuentra en el directorio de trabajo):

```{r, warning=FALSE, message=FALSE}
d <- readRDS('extraccion_20210514.rds')
```

Crear un gráfico de IET para las muestras tomadas en todas las estaciones contenidas en el conjunto de datos (usando las funciones `iet_tabla` (la cual internamente usa otra función, `iet`) y `g_iet` del paquete):

```{r, warning=FALSE, message=FALSE}
# Gráfico del IET:
d %>% iet_tabla() %>% g_iet()
```

Cálculo del Amoníaco Libre, usando la función `amoniaco_libre_add`:

```{r, warning=FALSE, message=FALSE}
# Agregar NH3L:
d <- amoniaco_libre_add(d)

# Se pueden ver algunos valores aquí:
d %>%
  filter(id_parametro == 2091) %>%
  select(codigo_pto, fecha_muestra, param, valor)

# Gráficos de nutrientes:
g_mes_pto_all(d, id_parametro = c(2098, 2101, 2099, 2097, 2102, 2091), ncol = 3)
```

> La función amoniaco_libre_add se creó para hacer los cálculos necesarios y agregar el parámetro NH3L a la tabla. Para ver detalles del cálculo en sí, ver `?amoniaco_libre`.

Las etiquetas del gráfico se pueden mejorar aún con la función `t_eti_add` (ver viñeta 'gráficos').

El paquete cuenta con otras funciones listas para crear gráficos de informes: ver `?g_mes_pto` o `?g_long` para más ejemplos, pero se recomienda especialmente leer la viñeta 'graficos'.

### Con datos incluidos en el paquete

El paquete viene con dos conjuntos de datos extraídos del SIA: ver `?datos_sia` o `?datos_sia_sed` para acceder a la documentación de estas tablas, con datos de aguas superficiales y de sedimentos, respectivamente.

Dichas tablas tienen todos los datos encontrados en SIA, a la fecha en que fueron extraidos, para todos los programas y parámetros disponibles. El objetivo de estas tablas es el de hacer pruebas, ejemplos y código que luego se puede aplicar a datos más actualizados (extraídos con iSIA).

Dado que se trata de tablas de gran tamaño (`datos_sia` tiene `r nrow(datos_sia)` filas y `r ncol(datos_sia)` columnas), es conveniente filtrarlos según el subconjunto de interés. Para esto es que el paquete cuenta con la función `filtrar_datos`, que replica las funcionalidades de filtro de iSIA.

El siguiente es un ejemplo datos similares al ejemplo usados anteriormente (la diferencia es el rango de fechas):

```{r}
d <- filtrar_datos(datos_sia, id_programa = 10L, id_matriz = 6L,
                   rango_fechas = c('2015-01-01', '2019-12-31'),
                   tipo_punto_id = 1L,
                   id_parametro = c(2098, 2101, 2099, 2097, 2102, 2032,
                                    2018, 2090, 2021, 2017))

g_long(d, 2098, anio = 2019)
```

> La idea de replicar la funcionalidad de iSIA es de poder hacer pruebas antes de descargar datos, incluso pensando en la automatización de reportes.



### Cálculos útiles

El paquete cuenta con algunas funciones relativamente simples que son de ayuda para realizar cálculos frecuentes: `iet`, `iet_tabla`, `amoniaco_libre`, `amoniaco_libre_add`, `media_geom`, `raiz` y `tsummary` .

#### Índice de estado trófico (IET)

La función `iet` calcula el IET para valores de Fósforo Total (en microgramos por litro):

```{r iet}
iet(c(25, 50, 75, 250))
PT <- seq(0, 300, by=5)
plot(PT, iet(PT), ylab = "IET", xlab = "PT (ug/L)", pch = 20)
```

#### Tabla con categorías de IET

Agrupa valores de IET por estación de monitoreo (`codigo_pto`), asignando  categorías a los valores según su IET (Oligotrófico, Mesotrófico, etc...). Usa la media geométrica para agrupar los valores encontrados.

```{r, warnings=FALSE}
d <- filtrar_datos(datos_sia, id_programa = 10L, id_matriz = 6L,
                   rango_fechas = c('2019-01-01', '2019-12-31'),
                   tipo_punto_id = 1L,
                   id_parametro = 2098)
iet_tabla(d)
```

La función puede, además, agrupar por otras columnas, como por ejemplo, mes, año, etc...

```{r, warnings=FALSE}
d <- filtrar_datos(datos_sia, id_programa = 10L, id_matriz = 6L,
                   rango_fechas = c('2017-01-01', '2019-12-31'),
                   tipo_punto_id = 1L,
                   id_parametro = 2098)
iet_tabla(d, mes)
iet_tabla(d, anio, mes)

# Esta función se puede combinar con herramientas de dplyr fácilmente:
iet_tabla(d, anio) %>%
  group_by(anio, categ) %>%
  tsummary(IET)
```

#### Estadísticas resumen

La función **`tsummary`** es una ayuda para obtener cálculos similares a los de `summary`, que permite agregar según distintas variables (i.e.: columnas). Hay que tener en cuenta que sólamente puede hacer cálculos con variables numéricas.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(siabox)

# Uso de tsummary para resumir datos de Clorofila-A en el programa Río Cuareim:
datos_sia %>% 
  filter(param == 'Clo_a', id_programa == 5) %>% 
  tsummary(valor)

# Lo mismo, pero agrupando por estación de monitoreo:
datos_sia %>% 
  filter(id_parametro == 2000, id_programa == 5) %>% 
  group_by(codigo_pto) %>% 
  tsummary(valor)
```

> Nota: el primer ejemplo y el segundo difieren en 2 aspectos: el agrupamiento (con la función `group_by`, de [dplyr](https://dplyr.tidyverse.org/)) y las referencias al parámetro por nombre y por id. Tanto parámetros como otras categorías importantes, como programas de monitoreo, estaciones y unidades de medida, tienen varias formas de ser identificados, siendo id la única permanente.

Otra función incluida en el paquete es `raiz`, que calcula la raíz enésima de un valor dado, incluso cuando ese valor es negativo (con el requisito de que n debe ser impar). La misma es usada, a su vez, por otra función incluida: `media_geom` (la [Media Geométrica](https://es.wikipedia.org/wiki/Media_geom%C3%A9trica)).

```{r, warning=FALSE, message=FALSE}
# Cálculo de la raíz enésima:
tibble(x = c(4, -4, 4, -4), n = c(2, 2, 3, 3)) %>%
  mutate(raiz(x, n), x ^ (1 / n), abs(x) ^ (1 / n))

# Cálculo de una media geométrica con valores aleatorios:
x <- rnorm(100, 8)
mean(x)
media_geom(x)
```


## Para desearrolladores

> (Sección que, al menos en parte, escribo para refrescar mi propia memoria.)

Este paquete se creó siguiendo de forma aproximada los consejos del libro [R Packages](https://r-pkgs.org/index.html) de Hadley Wickham. El libro entero es importante para entender el desarrollo de paquetes (o la documentación original de CRAN), pero para referencia rápida de quien ya sabe la teoría y sólo tiene que recordar el flujo, ir directamente al capítulo 5: [Fundamental development workflows](https://r-pkgs.org/workflows101.html).

Algunas notas:

- Al usar funciones de paquetes externos, evitar `require` o `library`; usar en cambio los operadores `::` o `:::`. Ejemplo: `dplyr::filter`. Eso evita afectar el ambiente de trabajo del usuario final (o sea, no hay que cargar todo el paquete `siabox` para usar una única función; `tsummary` es un ejemplo de función útil en sí misma). En este paquete las excepciones son `ggplot2` y `%>%`, ya que de otra forma el código se vuelve muy engorroso rápidamente.

- Lo mismo para trabajar con los conjuntos de datos del paquete... Sucede que las funciones del paquete tienen asociado un NAMESPACE, así que cuando se llama a una función de `siabox` desde el cuerpo de otra función de `siabox`, se sobreentiende que el NAMESPACE del paquete está incluido en el camino de búsqueda de funciones. Pero esto no ocurre con los datasets (supongo que los creadores de R nunca lo consideraron necesario). Por esta razón, siempre que se, por ejemplo, `sia_parametro` dentro de una función de `siabox`, hay que escribir `siabox::sia_parametro`.

- La función `devtools::load_all()` (Ctrl+Shift+L) sirve para "cargar" el paquete en la sesión, incluyendo funciones, viñetas, y otros códigos. Conviene correrlo cada vez que cambiamos alguna función y queremos probarla, por ejemplo.

- La función `devtools::document()` (Ctrl+Shift+D) sirve para actualizar los archivos de documentación.

```{r fin, include=FALSE}
unlink('extraccion_20210514.rds')
```
