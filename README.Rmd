---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. 

NO TOCAR HASTA NO TENER EL PAQUETE INSTALADO Y ANDANDO ASÍ DEJO DE TENER
PROBLEMAS CON FUNCIONES QUE SUPUESTAMENTE NO ESTÁN (CRUZO LOS DEDOS)

Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(tibble)
library(manoSIAR)
d <- filtrar_datos(datos_sia, id_programa = 10L, id_matriz = 6L,
                   rango_fechas = c('2019-01-01', '2019-06-30'),
                   tipo_punto_id = 1L,
                   id_parametro = c(2000L, 2017L, 2018L, 2021L, 2032L, 2090L,
                                    2097L, 2098L, 2099L, 2101L, 2102L))
saveRDS(d, 'extraccion_20210213.rds')
```

# manoSIAR

<!-- badges: start -->
<!-- badges: end -->

Este paquete contiene funciones y datos utilizados para trabajar con las bases datos del SIA. De momento no es muy grande pero abarca tareas diversas, tales como las que se usan en las aplicaciónes Shiny (vSIA, hSIA e iSIA), o funciones para hacer gráficas que sirven para hacer informes.

Tiene además un grupo no menor de tablas, incluyendo varias de la base de datos INFAMBIENTALBD del SIA.

Para usar el paquete se recomienda el uso de [tidyverse](https://www.tidyverse.org/) en general y muchos de los paquetes necesarios son de ese conjunto.

## Modo de uso (proyectado)

Básicamente se puede trabajar con datos extraidos del iSiA en el momento o usar datos que ya están en el paquete para analizar o hacer pruebas, que luego se podrán utilizar con datos más recientes (tomados del iSIA).

La idea es también usar las herramientas del paquete para armar archivos Rmarkdown que serían templates para informes semiautomatizados. Hay un ejemplo para Laguna Merín para empezar.

### Con datos extraídos desde iSIA

La idea es que las funciones de este paquete funcionen bien con datos extraídos desde iSIA. La forma más fácil es elegir el formato .RDS, que es nativo de R:

```{r, warning=FALSE, message=FALSE}
library(manoSIAR)
library(dplyr)
# Importación de datos extraídos de iSIA:
d <- readRDS('extraccion_20210213.rds')

# media_geom(rnorm(100, 5))
# par_id("fosforo")


# Gráfico del IET:
d %>%
  # Sólo queremos PT:
  filter(id_parametro == 2098) %>%
  # Agregamos columna IET:
  mutate(IET = iet(valor)) %>%
  # El gráfico:
  g_iet()

# Agregar NH3L:
# d <- amoniaco_libre_add(d)

# Gráficos de nutrientes:
# g_mes_pto_all(d, id_parametro = c(2098, 2101, 2099, 2097, 2102, 2091), ncol = 3)
```

Así como este gráfico de IET, hay otras funciones en el paquete 

#### Formato

Estas tablas se encuentran en formato 'largo', es decir que los valores numéricos están todos en una única columna (`valor`), mientras que los distintos parámetros están indicados en otras columnas (ver `?datos_sia`). Entre otras cosas, este formato implica que hay varias filas para una misma muestra.

```{r}
summary(d$valor)

# Cantidad de filas por muestra (n):
dplyr::count(d, id_muestra)
```

Es posible reconfigurar estas tablas con la función `ancho`, que es un [wrapper](https://en.wikipedia.org/wiki/Wrapper_function) de [`pivot_wider`](https://tidyr.tidyverse.org/reference/pivot_wider.html) (que a su vez es una versión más moderna de `reshape`), de forma que los valores se reparten en distintas columnas, nombradas según sus parámetros correspondientes. Esto es útil en muchas instancias, como por ejemplo, hacer gráficos de dispersión entre diferentes variables:

```{r}
da <- ancho(d)
names(da)[28:60]
plot(SatO ~ OD, data = da)
```

Como es de esperar, en este caso cada muestra ocupa una única fila:

```{r}
dplyr::count(da, id_muestra)
```


## Tablas de infambiental (base de datos)

Es la base de datos en donde se almacena mucha información concerniente al SIA, especialmente la de monitoreos de aguas y sedimentos, incluyendo lo relativo a los programas de monitoreo (estaciones, cuencas, etc), parámetros (nombres, unidades de medida según matriz, etc.). No incluye datos de aire.

Este paquete cuenta con copias de muchas de las tablas contenidas en esta base de datos, en [clase](https://bookdown.org/jboscomendoza/r-principiantes4/tipos-de-datos.html) [**data.frame**](https://bookdown.org/jboscomendoza/r-principiantes4/data-frames.html) (en verdad, usa una variante más moderna: [tibble](https://r4ds.had.co.nz/tibbles.html)).

Todas las tablas traídas de infambiental se nombran combinando el prefijo *sia_* con el nombre original. Ejemplo: la tabla `sia_parametro` contiene la misma información que la tabla `parametro` de infambiental.

Como se estila en bases de datos, estas tablas generalmente hay una columna dedicada a un "id": un indentificador numérico que es único para cada entrada, la cual generalmente se llama `id_...` o simplemente `id`. Por ejemplo, en la tabla `sia_parametro`, la columna `id_parametro` identifica a cada parámetro con un número entero positivo. El rol de los identificadores es evitar ambigüedades. Por ejemplo, podemos usar el `id_parametro` para asegurarnos de que trabajamos con el parámetro que nos interesa; en el caso del Fósforo Total figura, el `id_parametro` es 2098:


<!-- ```{r sia_parametro} -->
``` r
library(manoSIAR)
dplyr::filter(sia_parametro, id_parametro == 2098)
```

| id_parametro|parametro     |enumerado |nombre_clave | decimales|par_vigente |codigo_airviro |
|------------:|:-------------|:---------|:------------|---------:|:-----------|:--------------|
|         2098|Fósforo total |FALSE     |PT           |         9|TRUE        |NA             |

> **NOTA**: En general, al exportar datos desde infambiental (i.e.: muestras con valores de parámetros), la regla que uso es usar nombres de `id` descriptivos, para las tablas principales (programas, estaciones, parámetros, etc). Entonces, si bien originalmente hay una columna `id` en la tabla `estacion`, cuando hago la importación se convierte en `id_estacion`. Esto aplica tanto para iSIA como para los datos contenidos en este paquete. De todas formas hay algunas tablas que mantienen los nombres de su

Las tablas más importantes son:

- datos_sia: datos de matriz Aguas superficiales y datos_sia_sed de Sedimentos, extraidos el 2020-11-04.

 

### Buscadores de ID

El paquete incluye buscadores de id para las varias tablas importadas del SIA, usando un texto (i.e.: un Google de ids). El texto o patrón puede ser una expresión regular (la cual se pasa internamente a [`agrepl`](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/agrep)).

pro_id: Busca programas en sia_programa en base al campo nombre_programa de dicha tabla.

est_id: Busca estaciones en sia_estacion en base a los campos codigo_pto y estacion de dicha tabla.

mat_id: Busca matrices en sia_matriz en base al campo nombre de dicha tabla.

uni_id: Busca unidades en sia_unidad en base al campo uni_nombre de dicha tabla.

ins_id: Busca instituciones en sia_institucion en base al campo nombre de dicha tabla.

dep_id: Busca departamentos en sia_departamento en base al campo dep_nombre de dicha tabla.


<!--
## Installation

You can install the released version of manoSIAR from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("manoSIAR")
```

El paquete se puede descargar desde [GitHub](https://github.com/) mediante los comandos:

``` r
# install.packages("devtools")
devtools::install_github("jumanbar/manoSIAR")
```
-->


## Funciones (cálculos)

### Índice de estado trófico (IET)

La función `iet` calcula el IET para valores de Fósforo Total (en microgramos por litro):

```{r iet}
library(manoSIAR)
iet(c(25, 50, 75, 250))
plot(iet(1:300), ylab = "IET", xlab = "PT (ug/L)", pch = 20)
```

### Tabla con categorías de IET

Toma datos de SIA y 

```{r, warnings=FALSE}
# d <- filtrar_datos(datos_sia, id_programa = 10L, rango_fechas = 2019)
# iet_tabla(d)
# iet_tabla(d, mes)
# d <- filtrar_datos(datos_sia, id_programa = 10L,
#                    rango_fechas = c("2009-01-01", "2019-12-31"))
# iet_tabla(d, anio)
# iet_tabla(d, anio) %>%
#   dplyr::group_by(anio) %>%
#   dplyr::summarise(n = sum(!is.na(IET)), IET = mean(IET, na.rm = TRUE))
```



- - -

## Para desearrolladores

> (Sección que, al menos en parte, escribo para refrescar mi propia memoria.)

Este paquete se creó siguiendo de forma aproximada los consejos del libro [R Packages](https://r-pkgs.org/index.html) de Hadley Wickham. El libro entero es importante para entender el desarrollo de paquetes (o la documentación original de CRAN), pero para referencia rápida de quien ya sabe la teoría y sólo tiene que recordar el flujo, ir directamente al capítulo 5: [Fundamental development workflows](https://r-pkgs.org/workflows101.html).

Algunas notas:

- En funciones no usar `require` o `library`, sino el operador `::`. Ejemplo: `dplyr::filter`. Eso evita afectar el ambiente de trabajo del usuario. La excepción es `ggplot2`, porque se vuelve muy engorroso si no.

- La función `devtools::load_all()` (Ctrl+Shift+L) sirve para "cargar" el paquete en la sesión, incluyendo funciones, viñetas, y otros códigos. Conviene correrlo cada vez que cambiamos alguna función y queremos probarla, por ejemplo.

- La función `devtools::document()` (Ctrl+Shift+D) sirve para actualizar los archivos de documentación.

```{r fin, include=FALSE}
unlink('extraccion_20210213.rds')

```

